package org.thingsboard.integration.custom.client;

import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.SimpleChannelInboundHandler;
import lombok.extern.slf4j.Slf4j;

import javax.xml.bind.DatatypeConverter;
import java.util.concurrent.TimeUnit;

@Slf4j
public class TCPClientSimpleChannelInboundHandler extends SimpleChannelInboundHandler<Object> {

    private TCPClient tcpClient;
    private String client_imev;
    private int numberOfData1 ;

    public TCPClientSimpleChannelInboundHandler(TCPClient tcpClient, String client_imev) {
        this.tcpClient = tcpClient;
        this.client_imev = client_imev;
    }

    @Override
    protected void channelRead0(ChannelHandlerContext channelHandlerContext, Object msg) throws Exception {
        byte[] msgBytes = (byte[]) msg;
        String testIn = new String(msgBytes);
        log.error("Client received the message: {}", testIn);
        if (msgBytes.length == 1 && msgBytes[0] == 1) {
            byte [] sentB = sentMsg();
            numberOfData1 = sentB[9];
            this.tcpClient.clientChannel.writeAndFlush(sentB);
        }
        else if (msgBytes.length == 1 && msgBytes[0] == (byte)numberOfData1) {
            this.tcpClient.clientChannel.flush();
            this.tcpClient.clientChannel.close();
            log.error("Client close: {}", this.client_imev);
        }
    }

//    private void startGenerator() {
//        this.tcpClient.scheduledExecutorService.scheduleAtFixedRate(() ->
//                this.tcpClient.clientChannel.writeAndFlush(generateImevByte(client_imev)), 0, this.tcpClient.msgGenerationIntervalMs, TimeUnit.MILLISECONDS);
//    }

    private byte[] sentMsg() {
        String msg = "";
        switch (this.client_imev) {
            case "359633100458591":
                msg = "00000000000004cb0811000000f9d0e26a6a00000000000000000000000000000000f00f07ef00f00050001503c8004502715306b50000b600004208e7180000430f7044000002f10000639d100000000000000000f9d0e26a6000000000000000000000000000000000ef0f07ef00f00050001503c8004502715306b50000b600004208e7180000430f7044000002f10000639d100000000000000000f9d0e2667800000000000000000000000000000000000f07ef01f00150001503c8004502715606b50000b60000420baa180000430f8444000002f10000639d100000000000000000f9d0e0b0f800000000000000000000000000000000000f07ef01f00150011504c8004502715b06b50000b60000422f4c180000430fb844000002f10000639d100000000000000000f9d0dc1d1800000000000000000000000000000000000f07ef01f00150011504c8004502715b06b50000b60000422f49180000430fb844000002f10000639d100000000000000000f9d0d7893800000000000000000000000000000000000f07ef01f00150011503c8004502715b06b50000b60000422f4c180000430fb844000002f10000639d100000000000000000f9d0d2f55800000000000000000000000000000000000f07ef01f00150011503c8004502715b06b50000b60000422f4d180000430fb844000002f10000639d100000000000000000f9d0ce617800000000000000000000000000000000000f07ef01f00150011503c8004502715b06b50000b60000422f4a180000430fb844000002f10000639d100000000000000000f9d0c9cd9800000000000000000000000000000000000f07ef01f00150011504c8004502715b06b50000b60000422f4e180000430fb844000002f10000639d100000000000000000f9d0c539b800000000000000000000000000000000000f07ef01f00150011504c8004502715b06b50000b60000422f4e180000430fb844000002f10000639d100000000000000000f9d0c0a5d800000000000000000000000000000000000f07ef01f00150011504c8004502715b06b50000b60000422f50180000430fb844000002f10000639d100000000000000000f9d0bc11f800000000000000000000000000000000000f07ef01f00150011504c8004502715b06b50000b60000422f49180000430fb844000002f10000639d100000000000000000f9d0b30d6000000000000000000000000000000000000f07ef01f00150011503c8004502715b06b50000b60000422f4c180000430fb844000002f10000639d100000000000000000f9d0ae798000000000000000000000000000000000000f07ef01f00150011503c8004502715b06b50000b60000422f4e180000430fb844000002f10000639d100000000000000000f9d0a9e5a000000000000000000000000000000000000f07ef01f00150011504c8004502715b06b50000b60000422f50180000430fb844000002f10000639d100000000000000000f9d0a551c000000000000000000000000000000000000f07ef01f00150011503c8004502715b06b50000b60000422f49180000430fb844000002f10000639d100000000000000000f9d0a0bde000000000000000000000000000000000000f07ef01f00150011503c8004502715b06b50000b60000422f4e180000430fb844000002f10000639d1000000000001100005249";
                break;
            case "359633100458592":
                msg = "00000000000004cb0811000000f9cfb442d000000000000000000000000000000000000f07ef01f00150011504c8004502715a06b50000b60000422f4c180000430fb344000002f10000639d100000000000000000f9cfafaef000000000000000000000000000000000000f07ef01f00150011504c8004502715a06b50000b60000422f51180000430fb344000002f10000639d100000000000000000f9cfab1b1000000000000000000000000000000000000f07ef01f00150011504c8004502715a06b50000b60000422f52180000430fb344000002f10000639d100000000000000000f9cfa6873000000000000000000000000000000000000f07ef01f00150011504c8004502715a06b50000b60000422f51180000430fb344000002f10000639d100000000000000000f9cfa1f35000000000000000000000000000000000000f07ef01f00150011504c8004502715a06b50000b60000422f50180000430fb344000002f10000639d100000000000000000f9cf9d5f7000000000000000000000000000000000000f07ef01f00150011504c8004502715a06b50000b60000422f53180000430fb344000002f10000639d100000000000000000f9cf98cb9000000000000000000000000000000000000f07ef01f00150011504c8004502715a06b50000b60000422f4f180000430fb344000002f10000639d100000000000000000f9cf9437b000000000000000000000000000000000000f07ef01f00150011504c8004502715a06b50000b60000422f4c180000430fb344000002f10000639d100000000000000000f9cf8fa3d000000000000000000000000000000000000f07ef01f00150011504c8004502715a06b50000b60000422f4a180000430fb344000002f10000639d100000000000000000f9cf8b0ff000000000000000000000000000000000000f07ef01f00150011504c8004502715a06b50000b60000422f4b180000430fb344000002f10000639d100000000000000000f9cf867c1000000000000000000000000000000000000f07ef01f00150011504c8004502715a06b50000b60000422f4d180000430fb344000002f10000639d100000000000000000f9cf81e83000000000000000000000000000000000000f07ef01f00150011504c8004502715a06b50000b60000422f52180000430fb344000002f10000639d100000000000000000f9cf7d545000000000000000000000000000000000000f07ef01f00150011504c8004502715a06b50000b60000422f4c180000430fb344000002f10000639d100000000000000000f9cf78c07000000000000000000000000000000000000f07ef01f00150011504c8004502715a06b50000b60000422f4e180000430fb344000002f10000639d100000000000000000f9cf742c9000000000000000000000000000000000000f07ef01f00150011504c8004502715a06b50000b60000422f4c180000430fb344000002f10000639d100000000000000000f9cf6f98b000000000000000000000000000000000000f07ef01f00150011504c8004502715a06b50000b60000422f4c180000430fb344000002f10000639d100000000000000000f9cf6b04d000000000000000000000000000000000000f07ef01f00150011504c8004502715a06b50000b60000422f4c180000430fb344000002f10000639d100000000000110000df35";
                break;
            default:
        }
        return DatatypeConverter.parseHexBinary(msg);
    }

//
//    private byte[] generateImevByte(String client_imev) {
//        byte imev[] = new byte[17];
//        byte[] imevBB = client_imev.getBytes();
//        byte[] imevH = new byte[]{0x00, 0x0F};
//        System.arraycopy(imevH, 0, imev, 0, 2);
//        System.arraycopy(imevBB, 0, imev, 2, 15);
//        return imev;
//    }
}
